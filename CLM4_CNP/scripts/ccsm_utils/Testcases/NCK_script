#!/bin/csh -f
#======================================================================
# Clear coupler log files for validation test
#======================================================================
unsetenv CPLLOG_INIT

#======================================================================
# do a 5 day initial run test with NINST 1
#======================================================================
cd $CASEROOT
echo "doing a 5 day initial test with NINST 1" >>& $TESTSTATUS_LOG 

source ./Tools/ccsm_getenv || exit -3
./xmlchange -file env_run.xml -id CONTINUE_RUN -val FALSE
./xmlchange -file env_run.xml -id STOP_OPTION  -val ndays 
./xmlchange -file env_run.xml -id STOP_N       -val 5
./xmlchange -file env_run.xml -id REST_OPTION  -val none
./xmlchange -file env_mach_pes.xml -id NINST_ATM  -val 1
./xmlchange -file env_mach_pes.xml -id NINST_LND  -val 1
./xmlchange -file env_mach_pes.xml -id NINST_OCN  -val 1
./xmlchange -file env_mach_pes.xml -id NINST_ICE  -val 1
./xmlchange -file env_mach_pes.xml -id NINST_GLC  -val 1
if ( $NTASKS_ATM > 1 ) then
  @ ntask = $NTASKS_ATM / 2
  ./xmlchange -file env_mach_pes.xml -id NTASKS_ATM  -val $ntask
endif
if ( $NTASKS_LND > 1 ) then
  @ ntask = $NTASKS_LND / 2
  ./xmlchange -file env_mach_pes.xml -id NTASKS_LND  -val $ntask
endif
if ( $NTASKS_OCN > 1 ) then
  @ ntask = $NTASKS_OCN / 2
  ./xmlchange -file env_mach_pes.xml -id NTASKS_OCN  -val $ntask
endif
if ( $NTASKS_ICE > 1 ) then
  @ ntask = $NTASKS_ICE / 2
  ./xmlchange -file env_mach_pes.xml -id NTASKS_ICE  -val $ntask
endif
if ( $NTASKS_GLC > 1 ) then
  @ ntask = $NTASKS_GLC / 2
  ./xmlchange -file env_mach_pes.xml -id NTASKS_GLC  -val $ntask
endif
rm -r -f $EXEROOT/csm_share
rm -r -f $EXEROOT/lib
./xmlchange -file env_build.xml -id NINST_BUILD -val 0
./configure -cleanall
./configure -case4test
./$CASE.build
./$CASE.run

gunzip $RUNDIR/cpl.log*.gz
set CplLogFile = `ls -1t $RUNDIR/cpl.log* | head -1`
setenv CPLLOG_INIT1 $CplLogFile
setenv BASEGEN_FILE01 $CplLogFile
echo "First Test log is $CPLLOG_INIT1" >>& $TESTSTATUS_LOG 

if ( $?CPLLOG_INIT1 ) then
  if ($CPLLOG_INIT1 == "") then
    echo "CPLLOG_INIT1 empty"
    set basestatus = "FAIL "
    echo "$basestatus " >>& $TESTSTATUS_LOG
    echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
    exit
  endif
  if (! -e $CPLLOG_INIT1) then
    echo "CPLLOG_INIT1 does not exist"
    set basestatus = "FAIL "
    echo "$basestatus " >>& $TESTSTATUS_LOG
    echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
    exit
  endif
  echo "Checking successful completion in cpl log file1" >>& $TESTSTATUS_LOG
  set pass = `grep "SUCCESSFUL TERM" $CPLLOG_INIT1 | wc -l`
  if ( $pass != 0 ) then
    set basestatus = "PASS "
    echo "$basestatus " >>& $TESTSTATUS_LOG
  else
    set basestatus = "FAIL "
    echo "$basestatus " >>& $TESTSTATUS_LOG
    echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
    exit
  endif
else
  echo "ERROR in ${0}:  initial coupler log file1 NOT set" >>& $TESTSTATUS_LOG
  set basestatus = "ERROR"
  echo "$basestatus " >>& $TESTSTATUS_LOG
  echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
  exit
endif

#======================================================================
# do a 5 day initial run test with NINST 2
# want to run on same pe counts per instance and same cpl pe count
#======================================================================
cd $CASEROOT
echo "doing a 5 day initial test with NINST 2" >>& $TESTSTATUS_LOG 

source ./Tools/ccsm_getenv || exit -3
./xmlchange -file env_run.xml -id CONTINUE_RUN -val FALSE
./xmlchange -file env_run.xml -id STOP_OPTION  -val ndays 
./xmlchange -file env_run.xml -id STOP_N       -val 5
./xmlchange -file env_run.xml -id REST_OPTION  -val none
./xmlchange -file env_mach_pes.xml -id NINST_ATM  -val 2
./xmlchange -file env_mach_pes.xml -id NINST_LND  -val 2
./xmlchange -file env_mach_pes.xml -id NINST_OCN  -val 2
./xmlchange -file env_mach_pes.xml -id NINST_ICE  -val 2
./xmlchange -file env_mach_pes.xml -id NINST_GLC  -val 2
@ ntask = $NTASKS_ATM * 2
./xmlchange -file env_mach_pes.xml -id NTASKS_ATM  -val $ntask
@ ntask = $NTASKS_LND * 2
./xmlchange -file env_mach_pes.xml -id NTASKS_LND  -val $ntask
@ ntask = $NTASKS_OCN * 2
./xmlchange -file env_mach_pes.xml -id NTASKS_OCN  -val $ntask
@ ntask = $NTASKS_ICE * 2
./xmlchange -file env_mach_pes.xml -id NTASKS_ICE  -val $ntask
@ ntask = $NTASKS_GLC * 2
./xmlchange -file env_mach_pes.xml -id NTASKS_GLC  -val $ntask

rm -r -f $EXEROOT/csm_share
rm -r -f $EXEROOT/lib
./xmlchange -file env_build.xml -id NINST_BUILD -val 0
./configure -cleanall
./configure -case4test
./$CASE.build
./$CASE.run

gunzip $RUNDIR/cpl.log*.gz
set CplLogFile = `ls -1t $RUNDIR/cpl.log* | head -1`
setenv CPLLOG_INIT2 $CplLogFile
setenv BASEGEN_FILE02 $CplLogFile
echo "Second Test log is $CPLLOG_INIT2" >>& $TESTSTATUS_LOG 

#======================================================================
# runs complete
#======================================================================
setenv CPLLOG_GENCMP $CPLLOG_INIT2

#======================================================================
# Check case validation first
#======================================================================

set basestatus = "UNDEF"

if ( $?CPLLOG_INIT2 ) then
  if ($CPLLOG_INIT1 == "") then
    echo "CPLLOG_INIT1 empty"
    set basestatus = "FAIL "
    echo "$basestatus " >>& $TESTSTATUS_LOG
    echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
    exit
  endif
  if (! -e $CPLLOG_INIT1) then
    echo "CPLLOG_INIT1 does not exist"
    set basestatus = "FAIL "
    echo "$basestatus " >>& $TESTSTATUS_LOG
    echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
    exit
  endif
  if ($CPLLOG_INIT1 == $CPLLOG_INIT2) then
    echo "logs files are same name"
    set basestatus = "FAIL "
    echo "$basestatus " >>& $TESTSTATUS_LOG
    echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
    exit
  endif
  echo "Checking successful completion in cpl log file2" >>& $TESTSTATUS_LOG
  set pass = `grep "SUCCESSFUL TERM" $CPLLOG_INIT2 | wc -l`
  if ( $pass != 0 ) then
    set basestatus = "PASS "
    echo "$basestatus " >>& $TESTSTATUS_LOG
  else
    set basestatus = "FAIL "
    echo "$basestatus " >>& $TESTSTATUS_LOG
    echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
    exit
  endif
else
  echo "ERROR in ${0}:  initial coupler log file2 NOT set" >>& $TESTSTATUS_LOG
  set basestatus = "ERROR"
  echo "$basestatus " >>& $TESTSTATUS_LOG
  echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT
  exit
endif

# Compare the log files

echo "diff log files " >>& $TESTSTATUS_LOG
set basestatus = "PASS "

set cfile1 = $RUNDIR/commdiag1
set cfile2 = $RUNDIR/commdiag2

echo "cfile1 = $cfile1" >>& $TESTSTATUS_LOG
echo "cfile2 = $cfile2" >>& $TESTSTATUS_LOG

rm -f $cfile1
rm -f $cfile2

grep -i comm_diag $CPLLOG_INIT1                                   >! $cfile1
grep -i comm_diag $CPLLOG_INIT2 | grep -i _0002 | sed 's/_0002//' >! $cfile2

set pass = `diff cfile1 cfile2 | grep -i comm_diag | wc -l`
if ($pass != 0) set basestatus = "FAIL "

echo "$basestatus " >>& $TESTSTATUS_LOG
echo "$basestatus ${CASEBASEID} " >&! $TESTSTATUS_OUT

